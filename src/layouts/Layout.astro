---
import { type SiteConfig, type CustomImage } from 'types';
import { fetchData } from '@data/siteConfig';
import { urlFor } from '../utils/sanity-client';
import Cursor from '../components/Cursor.astro';
import '../styles/globals.css';

interface Props {
    title: string;
    addTitleSuffix?: boolean;
    description?: string;
    image?: CustomImage;
    seoTitle?: string;
    seoDescription?: string;
    seoImage?: CustomImage;
}

const { addTitleSuffix } = Astro.props;

const configData: SiteConfig = (await fetchData()) || {};

const globalZoom = configData.globalZoom ?? 0.8;

// Title Logic: Project SEO Title > Page Title > Global Logic
const titleSuffix = configData.titleSuffix && addTitleSuffix !== false ? configData.titleSuffix : undefined;
const baseTitle = Astro.props.seoTitle || Astro.props.title;
const title = [baseTitle, titleSuffix].filter(Boolean).join(' | ');

// Description Logic: Project SEO > Page Description > Global SEO > Default
const description = Astro.props.seoDescription || Astro.props.description || configData.seoDescription;

// Image Logic: Project SEO > Page Image > Global SEO
const imageObj = Astro.props.seoImage || Astro.props.image || configData.seoImage;
const resolvedImage = imageObj?.asset
    ? { src: new URL(urlFor(imageObj).width(1200).height(630).url(), Astro.site).toString() }
    : imageObj?.src
      ? { src: new URL(imageObj.src, Astro.site).toString() }
      : undefined;

// Keywords
const keywords = configData.seoKeywords ? configData.seoKeywords.join(', ') : undefined;

const canonicalURL = new URL(Astro.request.url, Astro.site);

function formatCanonicalURL(url: string | URL) {
    const path = url.toString();
    const hasQueryParams = path.includes('?');
    if (hasQueryParams) {
        path.replace(/\/?$/, '');
    }
    return path.replace(/\/?$/, hasQueryParams ? '' : '/');
}
---

<!doctype html>
<html lang="en" class="light" style={`zoom: ${globalZoom};`}>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
        <title>{title}</title>
        <meta name="generator" content={Astro.generator} />

        <!-- Global Zoom Configuration -->
        <script is:inline define:vars={{ globalZoom }}>
            window.GLOBAL_ZOOM = globalZoom;
        </script>

        <!-- Fonts: Inter -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />

        <!-- GSAP -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js" is:inline></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/Draggable.min.js" is:inline></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/InertiaPlugin.min.js" is:inline></script>
        <script src="https://unpkg.com/lucide@latest" is:inline defer></script>

        <!-- Low Priority Global Metadata -->
        <!-- Favicon -->
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <link rel="sitemap" href="/sitemap-index.xml" />

        <!-- Page Metadata -->
        <link rel="canonical" href={formatCanonicalURL(canonicalURL)} />
        <meta name="description" content={description} />

        <!-- Open Graph / Facebook -->
        <meta property="og:url" content={formatCanonicalURL(canonicalURL)} />
        <meta property="og:title" content={title} />
        <meta property="og:description" content={description} />
        {resolvedImage?.src && <meta property="og:image" content={resolvedImage.src} />}
        {resolvedImage?.src && imageObj?.alt && <meta property="og:image:alt" content={imageObj.alt} />}

        <!-- X/Twitter -->
        <meta property="twitter:card" content="summary_large_image" />
        <meta property="twitter:url" content={formatCanonicalURL(canonicalURL)} />
        <meta property="twitter:title" content={title} />
        <meta property="twitter:description" content={description} />
        {resolvedImage?.src && <meta property="twitter:image" content={resolvedImage.src} />}
        {resolvedImage?.src && imageObj?.alt && <meta property="twitter:image:alt" content={imageObj.alt} />}
    </head>
    <body class="antialiased font-sans">
        <Cursor />
        <div class="ambient-blob"></div>

        <slot />

        <script is:inline>
            // Global Lucide Fallback
            window.addEventListener('load', () => {
                if (window.lucide) window.lucide.createIcons();
            });
        </script>
    </body>
</html>
