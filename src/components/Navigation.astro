---
import { fetchSiteSettings } from '@data/siteSettings';
import type { SiteSettings } from 'types';
import { PortableText } from '@portabletext/react';

const settings: SiteSettings =
    (await fetchSiteSettings()) ||
    ({
        title: 'Portfolio',
        mainMenu: []
    } as any);

const { mainMenu, contactEmail } = settings;
---

<nav class="fixed bottom-10 left-1/2 -translate-x-1/2 z-50 md:z-[70] pointer-events-auto transition-transform duration-300 hover:scale-[1.02]">
    <div class="apple-glass rounded-full p-1.5 flex items-center relative">
        <div id="nav-pill" class="absolute top-1.5 h-[calc(100%-12px)] rounded-full bg-[#1d1d1f] shadow-lg shadow-black/20 z-0 opacity-0 pointer-events-none">
        </div>
        <ul class="flex space-x-1 relative z-10 font-medium text-sm tracking-tight">
            {
                mainMenu?.map((sheet) => (
                    <li>
                        <button
                            data-sheet={sheet.slug.current}
                            onclick={`window.openSheet('${sheet.slug.current}')`}
                            class="nav-btn relative px-6 py-2.5 rounded-full text-black/60 hover:text-black [&.active]:text-white [&.active]:hover:text-white transition-colors duration-300 capitalize mix-blend-normal"
                        >
                            {sheet.title}
                        </button>
                    </li>
                ))
            }
        </ul>
    </div>
</nav>

<!-- DYNAMIC SHEETS -->
{
    mainMenu?.map((sheet) => (
        <div
            id={`sheet-${sheet.slug.current}`}
            class="sheet-panel fixed inset-y-0 right-0 w-full md:w-[600px] bg-[#F5F5F7] border-l border-black/5 z-[60] shadow-2xl p-0 flex flex-col translate-x-full overflow-hidden"
        >
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 480" class="sheet-floater" data-astro-cid-j7pv25f6="">
                <path
                    d="M480 210H312.4L430.9 91.5l-42.4-42.4L270 167.6V0h-60v167.6L91.5 49.1 49.1 91.5 167.6 210H0v60h167.6L49.1 388.5l42.4 42.4L210 312.4V480h60V312.4l118.5 118.5 42.4-42.4L312.4 270H480v-60z"
                    fill="currentColor"
                />
            </svg>
            {sheet.modules?.map((module: any) => {
                // ABOUT MODULE
                if (module._type === 'module.about')
                    return (
                        <div class="h-full flex flex-col">
                            <div class="p-6 md:p-8 md:w-full overflow-y-auto hide-scrollbar flex flex-col h-full relative z-10">
                                <div class="bg-white rounded-[40px] p-10 md:p-12 shadow-[0_20px_40px_-12px_rgba(0,0,0,0.06)]">
                                    <div class="flex justify-between items-center mb-10">
                                        <div class="flex items-center gap-3 opacity-60 hover:opacity-100 transition-opacity">
                                            <span class="text-[10px] font-bold tracking-[0.2em] text-gray-400 uppercase">{module.miniTitle || 'Profile'}</span>
                                        </div>
                                        <button
                                            onclick="window.closeSheets()"
                                            class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-400 hover:bg-gray-200 hover:text-gray-600 transition-colors"
                                        >
                                            <i data-lucide="x" class="w-4 h-4" />
                                        </button>
                                    </div>

                                    {module.image && (
                                        <div class="relative w-full aspect-[4/3] md:aspect-[3/2] bg-gray-100 overflow-hidden rounded-2xl mb-10 shrink-0 group">
                                            {module.image.asset && (
                                                <img
                                                    src={module.image.asset.url}
                                                    class="w-full h-full object-cover grayscale group-hover:grayscale-0 transition-all duration-700 transform group-hover:scale-105"
                                                    alt="About"
                                                />
                                            )}
                                        </div>
                                    )}

                                    <div class="flex-1">
                                        <h1 class="text-3xl font-bold tracking-tight text-[#1d1d1f] mb-6">{module.headline || sheet.title}</h1>
                                        <div class="text-[15px] leading-relaxed text-gray-500 font-medium mb-10">
                                            {module.content && <PortableText value={module.content} />}
                                        </div>
                                        {module.facts && (
                                            <div class="space-y-4 border-t border-gray-100 pt-8 mb-10">
                                                {module.facts.map((fact: any) => (
                                                    <div class="flex justify-between items-center text-sm group cursor-default">
                                                        <span class="text-gray-400 font-medium w-24 group-hover:text-gray-600 transition-colors">
                                                            {fact.label}
                                                        </span>
                                                        <span class="text-[#1d1d1f] font-semibold text-right">{fact.value}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                        {module.actionButton && (module.actionButton.fileUrl || module.actionButton.url) && (
                                            <a
                                                href={module.actionButton.fileUrl || module.actionButton.url}
                                                target="_blank"
                                                rel="noopener noreferrer"
                                                class="w-full bg-[#F5F5F7] hover:bg-[#E8E8ED] text-[#1d1d1f] rounded-full p-1.5 pr-6 flex items-center justify-between group transition-all duration-300"
                                            >
                                                <div class="bg-white rounded-full w-12 h-12 flex items-center justify-center shadow-sm text-gray-400 group-hover:text-black transition-colors">
                                                    <i data-lucide="arrow-down" class="w-5 h-5" />
                                                </div>
                                                <span class="font-semibold text-sm">{module.actionButton.label}</span>
                                                <div class="w-4" />
                                            </a>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    );

                // SERVICES MODULE
                if (module._type === 'module.services')
                    return (
                        <div class="p-6 md:p-8 h-full flex flex-col relative z-10">
                            <div class="bg-white rounded-[40px] p-10 md:p-12 shadow-[0_20px_40px_-12px_rgba(0,0,0,0.06)] flex flex-col h-full overflow-hidden">
                                <div class="flex justify-between items-center mb-10 shrink-0">
                                    <div class="flex items-center gap-3 opacity-60 hover:opacity-100 transition-opacity">
                                        <span class="text-[10px] font-bold tracking-[0.2em] text-gray-400 uppercase">{module.miniTitle || sheet.title}</span>
                                    </div>
                                    <button
                                        onclick="window.closeSheets()"
                                        class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-400 hover:bg-gray-200 hover:text-gray-600 transition-colors"
                                    >
                                        <i data-lucide="x" class="w-4 h-4" />
                                    </button>
                                </div>
                                <div class="overflow-y-auto hide-scrollbar flex-1">
                                    <div class="flex flex-col gap-4 font-sans">
                                        {module.services?.map((service: any) => (
                                            <div class="p-6 rounded-[24px] bg-[#F5F5F7] hover:bg-[#E8E8ED] transition-colors duration-300 group cursor-default">
                                                <div class="flex justify-between items-start mb-3">
                                                    <h3 class="font-bold text-[#1d1d1f]">{service.title}</h3>
                                                    <i
                                                        data-lucide={service.icon || 'star'}
                                                        class="w-5 h-5 text-gray-400 group-hover:text-black transition-colors"
                                                    />
                                                </div>
                                                <p class="text-xs text-gray-500 leading-relaxed font-medium">{service.description}</p>
                                            </div>
                                        ))}
                                    </div>
                                    {module.actionButton && (module.actionButton.fileUrl || module.actionButton.url) && (
                                        <a
                                            href={module.actionButton.fileUrl || module.actionButton.url}
                                            target="_blank"
                                            rel="noopener noreferrer"
                                            class="w-full mt-8 bg-[#1d1d1f] hover:bg-black text-white rounded-full p-1.5 pr-6 flex items-center justify-between group transition-all duration-300 shadow-lg shadow-black/20"
                                        >
                                            <div class="bg-white/10 rounded-full w-12 h-12 flex items-center justify-center text-white">
                                                <i data-lucide="download" class="w-5 h-5" />
                                            </div>
                                            <span class="font-semibold text-sm">{module.actionButton.label}</span>
                                            <div class="w-4" />
                                        </a>
                                    )}
                                </div>
                            </div>
                        </div>
                    );

                // CONTACT MODULE
                if (module._type === 'module.contact')
                    return (
                        <div class="p-6 md:p-8 h-full flex flex-col relative z-10">
                            <div class="bg-white rounded-[40px] p-10 md:p-12 shadow-[0_20px_40px_-12px_rgba(0,0,0,0.06)] flex flex-col h-full overflow-hidden">
                                <div class="flex justify-between items-center mb-10 shrink-0">
                                    <div class="flex items-center gap-3 opacity-60 hover:opacity-100 transition-opacity">
                                        <span class="text-[10px] font-bold tracking-[0.2em] text-gray-400 uppercase">{module.miniTitle || sheet.title}</span>
                                    </div>
                                    <button
                                        onclick="window.closeSheets()"
                                        class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-400 hover:bg-gray-200 hover:text-gray-600 transition-colors"
                                    >
                                        <i data-lucide="x" class="w-4 h-4" />
                                    </button>
                                </div>
                                <div class="mb-10 overflow-y-auto hide-scrollbar flex-1">
                                    <div class="mb-10">
                                        <h1 class="text-2xl font-bold tracking-tight text-[#1d1d1f]">{module.heading || "Let's create something together."}</h1>
                                        {module.subtitle && <p class="text-gray-500 mt-2 text-sm font-medium">{module.subtitle}</p>}
                                    </div>
                                    <form
                                        id={module.formName || 'contact'}
                                        class="space-y-5"
                                        onsubmit="window.submitContact(event)"
                                        name={module.formName || 'contact'}
                                        data-netlify="true"
                                        netlify-honeypot="bot-field"
                                    >
                                        <input type="hidden" name="form-name" value={module.formName || 'contact'} />
                                        <p class="hidden">
                                            <label>
                                                Don't fill this out if you're human: <input name="bot-field" />
                                            </label>
                                        </p>
                                        <div>
                                            <input
                                                type="text"
                                                name="name"
                                                required
                                                class="w-full bg-[#F5F5F7] border-2 border-transparent focus:bg-white focus:border-black/5 rounded-2xl px-5 py-4 text-[#1d1d1f] placeholder-gray-400 outline-none transition-all duration-300 font-medium"
                                                placeholder="Your Name"
                                            />
                                        </div>
                                        <div>
                                            <input
                                                type="email"
                                                name="email"
                                                required
                                                class="w-full bg-[#F5F5F7] border-2 border-transparent focus:bg-white focus:border-black/5 rounded-2xl px-5 py-4 text-[#1d1d1f] placeholder-gray-400 outline-none transition-all duration-300 font-medium"
                                                placeholder="Email Address"
                                            />
                                        </div>
                                        <div>
                                            <textarea
                                                name="message"
                                                required
                                                rows="4"
                                                class="w-full bg-[#F5F5F7] border-2 border-transparent focus:bg-white focus:border-black/5 rounded-2xl px-5 py-4 text-[#1d1d1f] placeholder-gray-400 outline-none transition-all duration-300 resize-none font-medium"
                                                placeholder="Project Details..."
                                            />
                                        </div>
                                        <button
                                            id="submitBtn"
                                            type="submit"
                                            class="w-full mt-4 bg-[#1d1d1f] hover:bg-black text-white rounded-full p-1.5 pr-6 flex items-center justify-between group transition-all duration-300 shadow-lg shadow-black/20"
                                        >
                                            <div class="bg-white/20 rounded-full w-12 h-12 flex items-center justify-center text-white group-hover:scale-110 transition-transform">
                                                <i data-lucide="send" class="w-5 h-5" />
                                            </div>
                                            <span class="font-semibold text-sm">Send Message</span>
                                            <div class="w-4" />
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    );

                // TEXT MODULE (Generic)
                if (module._type === 'module.text')
                    return (
                        <div class="p-6 md:p-8 h-full flex flex-col relative z-10">
                            <div class="bg-white rounded-[40px] p-10 md:p-12 shadow-[0_20px_40px_-12px_rgba(0,0,0,0.06)] overflow-y-auto hide-scrollbar flex-1">
                                <div class="flex justify-between items-center mb-10">
                                    <div class="flex items-center gap-3 opacity-60 hover:opacity-100 transition-opacity">
                                        <span class="text-[10px] font-bold tracking-[0.2em] text-gray-400 uppercase">{module.miniTitle || sheet.title}</span>
                                    </div>
                                    <button
                                        onclick="window.closeSheets()"
                                        class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-400 hover:bg-gray-200 hover:text-gray-600 transition-colors"
                                    >
                                        <i data-lucide="x" class="w-4 h-4" />
                                    </button>
                                </div>
                                {module.heading && <h1 class="text-3xl font-bold tracking-tight text-[#1d1d1f] mb-6">{module.heading}</h1>}
                                <div class="text-[15px] leading-relaxed text-gray-500 font-medium">
                                    {module.content && <PortableText value={module.content} />}
                                </div>
                            </div>
                        </div>
                    );
            })}
        </div>
    ))
}

<script is:inline>
    // --- SHEETS LOGIC ---
    let sheets = {};
    const navPill = document.getElementById('nav-pill');
    const navBtns = document.querySelectorAll('.nav-btn');
    const appleEase = 'cubic-bezier(0.32, 0.72, 0, 1)';

    function initSheets() {
        sheets = {};
        const sheetEls = document.querySelectorAll('.sheet-panel');
        sheetEls.forEach((el) => {
            sheets[el.id.replace('sheet-', '')] = el;
        });
    }

    // GSAP is globally available from Layout.astro

    // Initialize Swipe Handling for Sheets
    function initSwipeClose() {
        if (typeof Draggable === 'undefined') return;

        const sheetPanels = document.querySelectorAll('.sheet-panel');
        sheetPanels.forEach((panel) => {
            Draggable.create(panel, {
                type: 'x',
                trigger: panel,
                lockAxis: true,
                zIndexBoost: false, // Prevent overriding CSS z-index
                bounds: { minX: 0, maxX: 600 }, // Allow dragging right
                inertia: true,
                onDragEnd: function () {
                    // If dragged more than 100px to the right, close it
                    if (this.x > 100) {
                        window.closeSheets();
                        // Reset transform after animation is handled by closeSheets
                        // But closeSheets animates to 100% x.
                    } else {
                        // Snap back to 0
                        gsap.to(this.target, { x: 0, duration: 0.3, ease: 'power2.out' });
                    }
                }
            });
        });
    }

    // Call init on load
    window.addEventListener('load', initSwipeClose);

    window.openSheet = function (name) {
        initSheets();

        // Close others first
        Object.keys(sheets).forEach((key) => {
            if (key !== name) {
                gsap.to(sheets[key], { x: '100%', duration: 0.5, ease: 'power3.in' });
            }
        });

        const sheet = sheets[name];
        if (sheet) {
            // GSAP Animation for entering
            gsap.to(sheet, { x: '0%', duration: 0.8, ease: 'expo.out' });
        }

        // Hide Nav on Mobile
        if (window.innerWidth < 768) {
            gsap.to('nav', { y: 100, opacity: 0, duration: 0.3, ease: 'power2.in' });
        }

        // Pill Animation
        const btn = document.querySelector(`.nav-btn[data-sheet="${name}"]`);
        if (btn) {
            const rect = btn.getBoundingClientRect();
            const parentRect = btn.parentElement.parentElement.getBoundingClientRect();

            // Text color logic
            navBtns.forEach((b) => b.classList.remove('active'));
            btn.classList.add('active');

            gsap.to(navPill, {
                x: rect.left - parentRect.left,
                width: rect.width,
                opacity: 1,
                duration: 0.5,
                ease: appleEase
            });
        }
    };

    window.closeSheets = function () {
        initSheets();
        Object.values(sheets).forEach((s) => {
            gsap.to(s, { x: '100%', duration: 0.5, ease: 'power3.in' });
        });

        // Show Nav (always restore in case resizing, but strictly logic matches open)
        gsap.to('nav', { y: 0, opacity: 1, duration: 0.3, ease: 'power2.out' });

        gsap.to(navPill, { opacity: 0, duration: 0.3 });

        navBtns.forEach((b) => b.classList.remove('active'));
    };

    // --- CONTACT FORM LOGIC ---
    window.submitContact = function (e) {
        const form = e.target;
        const submitButton = form.querySelector('button[type="submit"]');
        const btnLabel = submitButton.querySelector('span');
        const originalLabel = btnLabel ? btnLabel.textContent : 'Send Message';

        e.preventDefault();

        if (btnLabel) btnLabel.textContent = 'Sending...';
        submitButton.classList.add('opacity-70', 'cursor-wait');

        const formData = new FormData(form);
        // Ensure form-name is present for Netlify
        if (!formData.get('form-name')) {
            formData.set('form-name', form.getAttribute('name'));
        }
        fetch('/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams(formData).toString()
        })
            .then(() => {
                if (btnLabel) btnLabel.textContent = 'Message Sent';
                submitButton.classList.remove('opacity-70', 'cursor-wait', 'bg-[#1d1d1f]');
                submitButton.classList.add('bg-green-600');
                form.reset();
                setTimeout(() => {
                    if (btnLabel) btnLabel.textContent = originalLabel;
                    submitButton.classList.remove('bg-green-600');
                    submitButton.classList.add('bg-[#1d1d1f]');
                }, 3000);
            })
            .catch((error) => {
                if (btnLabel) btnLabel.textContent = 'Error';
                console.error(error);
            });
    };

    // Initialize Lucide icons
    if (window.lucide) window.lucide.createIcons();
</script>
