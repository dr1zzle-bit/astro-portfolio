---
import { fetchSiteSettings } from '@data/siteSettings';
import type { SiteSettings, Service } from 'types';
import { PortableText } from '@portabletext/react';

const settings: SiteSettings =
    (await fetchSiteSettings()) ||
    ({
        title: 'Portfolio',
        services: [],
        about: []
    } as any);

const { about, services, contactEmail } = settings;
---

<nav class="fixed bottom-10 left-1/2 -translate-x-1/2 z-50 pointer-events-auto transition-transform duration-300 hover:scale-[1.02]">
    <div class="apple-glass rounded-full p-1.5 flex items-center relative">
        <div
            id="nav-pill"
            class="absolute top-1.5 h-[calc(100%-12px)] rounded-full bg-[#1d1d1f] shadow-lg shadow-black/20
                                  transition-all duration-500 ease-[cubic-bezier(0.32,0.72,0,1)] z-0 opacity-0"
        >
        </div>
        <ul class="flex space-x-1 relative z-10 font-medium text-sm tracking-tight">
            <li>
                <button
                    onclick="window.openSheet('about')"
                    class="nav-btn relative px-6 py-2.5 rounded-full text-black/60 hover:text-black transition-colors duration-300">About</button
                >
            </li>
            <li>
                <button
                    onclick="window.openSheet('services')"
                    class="nav-btn relative px-6 py-2.5 rounded-full text-black/60 hover:text-black transition-colors duration-300">Services</button
                >
            </li>
            <li>
                <button
                    onclick="window.openSheet('contact')"
                    class="nav-btn relative px-6 py-2.5 rounded-full text-black/60 hover:text-black transition-colors duration-300">Contact</button
                >
            </li>
        </ul>
    </div>
</nav>

<!-- SERVICES SHEET -->
<div
    id="sheet-services"
    class="sheet-panel fixed inset-y-0 right-0 w-full md:w-[500px] bg-white border-l border-black/5 z-40 transform translate-x-full shadow-2xl p-8 md:p-12 flex flex-col"
>
    <div class="flex justify-between items-center mb-8 shrink-0">
        <span class="font-sans font-bold text-[10px] text-black/30 uppercase tracking-widest">01 / Services</span>
        <button onclick="window.closeSheets()" class="p-2 hover:bg-muted rounded-full transition-colors"
            ><i data-lucide="x" class="w-5 h-5 opacity-50"></i></button
        >
    </div>

    <div class="overflow-y-auto no-scrollbar h-full">
        <div class="space-y-3 font-sans pb-8">
            {
                services?.map((service: Service) => (
                    <div class="group border border-border rounded-lg p-6 hover:border-black/30 transition-all cursor-default bg-white hover:bg-muted/30">
                        <div class="flex justify-between items-start mb-3">
                            <h3 class="font-bold text-lg tracking-tight">{service.title}</h3>
                            <i data-lucide={service.icon || 'star'} class="w-4 h-4 text-black/20 group-hover:text-black transition-colors" />
                        </div>
                        <p class="text-sm text-black/50 leading-relaxed font-medium">{service.description}</p>
                    </div>
                ))
            }
            {!services?.length && <p class="text-sm text-black/50">No services configured.</p>}

            <div class="pt-6 border-t border-border mt-4">
                <button
                    class="w-full bg-foreground text-white hover:opacity-90 h-12 rounded-md text-sm font-bold transition-opacity flex items-center justify-center gap-2"
                    >Download Rate Card</button
                >
            </div>
        </div>
    </div>
</div>

<!-- CONTACT SHEET -->
<div
    id="sheet-contact"
    class="sheet-panel fixed inset-y-0 right-0 w-full md:w-[450px] bg-white border-l border-black/5 z-40 transform translate-x-full shadow-2xl p-8 md:p-12 flex flex-col"
>
    <div class="flex justify-between items-center mb-10">
        <span class="font-sans font-bold text-[10px] text-black/30 uppercase tracking-widest">02 / Contact</span>
        <button onclick="window.closeSheets()" class="p-2 hover:bg-muted rounded-full transition-colors"
            ><i data-lucide="x" class="w-5 h-5 opacity-50"></i></button
        >
    </div>
    <form id="contactForm" class="space-y-8 flex-1" onsubmit="window.submitContact(event)" name="contact" data-netlify="true">
        <div class="space-y-2 group">
            <label class="text-[10px] font-medium text-black/50 uppercase tracking-widest group-focus-within:text-black transition-colors">Name</label>
            <input
                type="text"
                name="name"
                required
                class="w-full bg-transparent border-b border-border py-2 text-base font-medium text-black/80 focus:outline-none focus:border-black transition-colors placeholder:text-black/10"
                placeholder="Your Name"
            />
        </div>
        <div class="space-y-2 group">
            <label class="text-[10px] font-medium text-black/50 uppercase tracking-widest group-focus-within:text-black transition-colors">Email</label>
            <input
                type="email"
                name="email"
                required
                class="w-full bg-transparent border-b border-border py-2 text-base font-medium text-black/80 focus:outline-none focus:border-black transition-colors placeholder:text-black/10"
                placeholder="email@address.com"
            />
        </div>
        <div class="space-y-2 group">
            <label class="text-[10px] font-medium text-black/50 uppercase tracking-widest group-focus-within:text-black transition-colors">Request</label>
            <textarea
                name="message"
                required
                rows="4"
                class="w-full bg-transparent border-b border-border py-2 text-base font-medium text-black/80 focus:outline-none focus:border-black transition-colors placeholder:text-black/10 resize-none"
                placeholder="Project details..."></textarea>
        </div>
        <button
            id="submitBtn"
            type="submit"
            class="w-full bg-foreground text-white hover:opacity-90 h-12 rounded-md text-sm font-bold transition-all duration-300 flex items-center justify-center gap-2 mt-auto"
        >
            <span>Send Message</span>
            <i data-lucide="arrow-right" class="w-4 h-4"></i>
        </button>
    </form>
</div>

<!-- ABOUT SHEET -->
<div
    id="sheet-about"
    class="sheet-panel fixed inset-y-0 right-0 w-full md:w-[650px] bg-white border-l border-black/5 z-40 transform translate-x-full shadow-2xl p-0 flex flex-col md:flex-row"
>
    <div class="relative h-64 md:h-full md:w-1/2 bg-gray-50 overflow-hidden">
        <img src="https://images.unsplash.com/photo-1534528741775-53994a69daeb?q=80&w=600&auto=format" class="w-full h-full object-cover" alt="About" />
        <div class="absolute inset-0 bg-black/5"></div>
    </div>
    <div class="p-8 md:p-12 md:w-1/2 overflow-y-auto no-scrollbar flex flex-col">
        <div class="flex justify-between items-center mb-8">
            <span class="font-sans font-bold text-[10px] text-black/30 uppercase tracking-widest">00 / Profile</span>
            <button onclick="window.closeSheets()" class="p-2 hover:bg-muted rounded-full transition-colors"
                ><i data-lucide="x" class="w-5 h-5 opacity-50"></i></button
            >
        </div>
        <h2 class="text-3xl font-extrabold tracking-tighter mb-6">{settings.title}</h2>
        <div class="text-sm text-black/60 leading-relaxed mb-8 font-medium">
            {about ? <PortableText value={about} /> : <p>About content not set.</p>}
        </div>
        <div class="space-y-4 text-xs font-bold mt-auto">
            <div class="flex justify-between border-b border-border pb-2">
                <span class="text-black/40">Contact</span>
                <span>{contactEmail || 'hello@example.com'}</span>
            </div>
        </div>
    </div>
</div>

<script is:inline>
    // --- SHEETS LOGIC ---
    const sheets = {
        about: document.getElementById('sheet-about'),
        services: document.getElementById('sheet-services'),
        contact: document.getElementById('sheet-contact')
    };
    const navPill = document.getElementById('nav-pill');
    const navBtns = document.querySelectorAll('.nav-btn');
    const appleEase = 'cubic-bezier(0.32, 0.72, 0, 1)';

    window.openSheet = function (name) {
        window.closeSheets();
        const sheet = sheets[name];
        if (sheet) sheet.classList.remove('translate-x-full');

        // Find button by text content roughly
        const btn = Array.from(navBtns).find((b) => b.textContent.toLowerCase().includes(name));
        if (btn) {
            const rect = btn.getBoundingClientRect();
            const parentRect = btn.parentElement.parentElement.getBoundingClientRect();
            navBtns.forEach((b) => {
                b.classList.remove('text-white');
                b.classList.add('text-black/60');
            });
            btn.classList.remove('text-black/60');
            btn.classList.add('text-white');
            gsap.to(navPill, { x: rect.left - parentRect.left, width: rect.width, opacity: 1, duration: 0.5, ease: appleEase });
        }
    };

    window.closeSheets = function () {
        Object.values(sheets).forEach((s) => s && s.classList.add('translate-x-full'));
        gsap.to(navPill, { opacity: 0, duration: 0.3 });
        navBtns.forEach((b) => {
            b.classList.remove('text-white');
            b.classList.add('text-black/60');
        });
    };

    // --- CONTACT FORM LOGIC ---
    window.submitContact = function (e) {
        const btn = document.getElementById('submitBtn');
        const btnContent = btn.innerHTML;

        // Let natural form submission happen if using Netlify forms?
        // Or hijack for UI feedback then submit?
        // HTML template hijacks it.
        // Assuming Netlify AJAX, or just visual feedback.
        e.preventDefault();

        btn.innerHTML = 'Sending...';
        btn.classList.add('opacity-70', 'cursor-wait');

        setTimeout(() => {
            btn.innerHTML = 'Message Sent';
            btn.classList.remove('opacity-70', 'cursor-wait', 'bg-foreground', 'text-white');
            btn.classList.add('bg-green-600', 'text-white');
            document.getElementById('contactForm').reset();
            setTimeout(() => {
                btn.innerHTML = btnContent;
                btn.classList.remove('bg-green-600', 'text-white');
                btn.classList.add('bg-foreground', 'text-white');
            }, 3000);
        }, 1500);
    };

    // Initialize Lucide icons
    if (window.lucide) window.lucide.createIcons();
</script>
