---
import Layout from '@layouts/Layout.astro';
import Navigation from '@components/Navigation.astro';
import { fetchProjects, fetchProjectBySlug } from '@data/project';
import { urlFor } from '../../utils/sanity-client';
import { PortableText } from '@portabletext/react';
import type { Project } from 'types';

export async function getStaticPaths() {
    const projects = await fetchProjects();
    return projects
        .filter((project: any) => project.slug?.current)
        .map((project: any) => ({
            params: { slug: project.slug.current }
        }));
}

const { slug } = Astro.params;
const project: Project = await fetchProjectBySlug(slug as string);

if (!project) return Astro.redirect('/404');
---

<Layout title={project.title} seoTitle={project.seoTitle} seoDescription={project.seoDescription} seoImage={project.seoImage}>
    <!-- Navigation Overlay -->
    <header class="fixed top-0 left-0 w-full z-40 p-8 flex justify-between items-start pointer-events-none">
        <a href="/" class="pointer-events-auto cursor-pointer group">
            <div
                class="apple-glass rounded-full px-5 py-2.5 flex items-center gap-3 transition-all duration-300 hover:scale-[1.02] text-black/60 group-hover:text-black"
            >
                <i data-lucide="arrow-left" class="w-5 h-5 md:w-6 md:h-6 transition-transform duration-500 group-hover:-translate-x-1"></i>
                <h1 class="text-lg md:text-xl font-extrabold tracking-tighter transition-colors">Back</h1>
            </div>
        </a>
    </header>

    <!-- Combine Images for Lightbox -->
    <div class="pt-32 pb-20 px-4 md:px-8 max-w-7xl mx-auto min-h-screen">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-12 md:gap-24 mb-24 items-start">
            <div class="space-y-6">
                <h1 class="text-5xl md:text-7xl font-extrabold tracking-tighter">{project.title}</h1>
                <p class="text-xl md:text-2xl text-black/60 font-medium leading-relaxed">{project.description}</p>
                <div class="prose prose-lg mt-8 text-black/80 font-sans">
                    {project.details && <PortableText value={project.details} />}
                </div>
            </div>
            <div class="relative sticky top-32">
                {
                    project.mainImage?.asset && (
                        <img
                            src={urlFor(project.mainImage).width(1200).format('webp').url()}
                            alt={project.mainImage.alt || project.title}
                            class="w-full h-auto rounded-lg shadow-lg cursor-zoom-in hover:scale-[1.01] hover:opacity-90 transition-[transform,opacity] duration-500 ease-in-out will-change-transform"
                            onclick="openLightbox(0)"
                        />
                    )
                }
            </div>
        </div>

        {
            project.gallery && project.gallery.length > 0 && (
                <div class="columns-1 md:columns-2 lg:columns-3 gap-[10px] space-y-[10px]">
                    {project.gallery.map(
                        (image: any, index: number) =>
                            image.asset && (
                                <div class="break-inside-avoid rounded-lg overflow-hidden shadow-sm group">
                                    <img
                                        src={urlFor(image).width(800).format('webp').url()}
                                        alt={image.alt || ''}
                                        data-index={index + 1}
                                        class="w-full h-auto object-cover hover:scale-[1.02] hover:opacity-90 transition-[transform,opacity] duration-500 ease-in-out cursor-zoom-in gallery-img will-change-transform"
                                        loading="lazy"
                                        onclick={`openLightbox(${index + 1})`}
                                    />
                                </div>
                            )
                    )}
                </div>
            )
        }
    </div>

    <!-- LIGHTBOX OVERLAY -->
    <div
        id="lightbox"
        class="fixed inset-0 z-[100] bg-white/95 backdrop-blur-xl flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300"
    >
        <button onclick="closeLightbox()" class="absolute top-8 right-8 p-2 hover:bg-black/5 rounded-full transition-colors z-20">
            <i data-lucide="x" class="w-8 h-8 text-black/60"></i>
        </button>

        <button onclick="prevImage()" class="absolute left-2 md:left-8 top-1/2 -translate-y-1/2 p-3 md:p-4 hover:bg-black/5 rounded-full transition-all z-50">
            <i data-lucide="chevron-left" class="w-6 h-6 md:w-8 md:h-8 text-black/80"></i>
        </button>

        <button onclick="nextImage()" class="absolute right-2 md:right-8 top-1/2 -translate-y-1/2 p-3 md:p-4 hover:bg-black/5 rounded-full transition-all z-50">
            <i data-lucide="chevron-right" class="w-6 h-6 md:w-8 md:h-8 text-black/80"></i>
        </button>

        <div class="relative w-full h-full flex items-center justify-center p-4 md:p-20">
            <img id="lightbox-img" src="" class="max-w-full max-h-full object-contain shadow-2xl rounded-sm" />
            <div id="lightbox-loader" class="absolute inset-0 flex items-center justify-center">
                <div class="w-8 h-8 border-2 border-black/20 border-t-black rounded-full animate-spin"></div>
            </div>
        </div>

        <div class="absolute bottom-8 left-1/2 -translate-x-1/2 text-black/50 text-sm font-medium tracking-widest">
            <span id="lb-current">1</span> / <span id="lb-total">1</span>
        </div>
    </div>

    <Navigation />

    <script
        is:inline
        define:vars={{
            allImages: [
                project.mainImage
                    ? {
                          thumb: urlFor(project.mainImage).width(1200).format('webp').url(),
                          full: urlFor(project.mainImage).width(1800).format('webp').url(),
                          alt: project.mainImage.alt || project.title
                      }
                    : null,
                ...(project.gallery || []).map((img) => ({
                    thumb: urlFor(img).width(800).format('webp').url(),
                    full: urlFor(img).width(1800).format('webp').url(),
                    alt: img.alt || ''
                }))
            ].filter(Boolean)
        }}
    >
        if (window.lucide) window.lucide.createIcons();

        // LIGHTBOX LOGIC
        const lightbox = document.getElementById('lightbox');
        const lbImg = document.getElementById('lightbox-img');
        const lbLoader = document.getElementById('lightbox-loader');
        const lbCurrent = document.getElementById('lb-current');
        const lbTotal = document.getElementById('lb-total');

        let currentIndex = 0;
        const totalImages = allImages.length;

        // Initialize Total
        if (lbTotal) lbTotal.innerText = totalImages;

        window.openLightbox = function (index) {
            if (!allImages.length) return;
            currentIndex = index;
            updateLightbox(true);

            lightbox.classList.remove('pointer-events-none', 'opacity-0');
            document.body.style.overflow = 'hidden'; // Lock Scroll

            // GSAP Entrance
            gsap.fromTo(lbImg, { scale: 0.9, opacity: 0 }, { scale: 1, opacity: 1, duration: 0.4, ease: 'power3.out' });
        };

        window.closeLightbox = function () {
            lightbox.classList.add('opacity-0', 'pointer-events-none');
            document.body.style.overflow = ''; // Unlock Scroll
        };

        window.nextImage = function (e) {
            if (e) e.stopPropagation();
            currentIndex = (currentIndex + 1) % totalImages;
            updateLightbox();
        };

        window.prevImage = function (e) {
            if (e) e.stopPropagation();
            currentIndex = (currentIndex - 1 + totalImages) % totalImages;
            updateLightbox();
        };

        function updateLightbox(firstOpen = false) {
            const data = allImages[currentIndex];
            if (!data) return;

            // Show Loader
            lbLoader.classList.remove('hidden');
            if (!firstOpen) {
                gsap.to(lbImg, { opacity: 0.5, duration: 0.2 });
            }

            // Load Image
            const img = new Image();
            img.onload = () => {
                lbImg.src = data.full;
                lbLoader.classList.add('hidden');
                gsap.to(lbImg, { opacity: 1, duration: 0.3 });
            };
            img.src = data.full;

            // Update Counter
            lbCurrent.innerText = currentIndex + 1;
        }

        // Keyboard Nav
        document.addEventListener('keydown', (e) => {
            if (lightbox.classList.contains('opacity-0')) return;
            if (e.key === 'Escape') closeLightbox();
            if (e.key === 'ArrowRight') nextImage();
            if (e.key === 'ArrowLeft') prevImage();
        });

        // Background Click Close
        lightbox.addEventListener('click', (e) => {
            if (e.target === lightbox || e.target.parentElement === lightbox) {
                closeLightbox();
            }
        });

        // --- SWIPE TO NAVIGATE (Horizontal Only) ---
        let lightboxDrag;

        function initLightboxSwipe() {
            if (typeof Draggable === 'undefined') return;

            if (typeof InertiaPlugin !== 'undefined') gsap.registerPlugin(Draggable, InertiaPlugin);

            // Create a virtual proxy element to track drag
            const proxy = document.createElement('div');

            lightboxDrag = Draggable.create(proxy, {
                trigger: lightbox,
                type: 'x', // Horizontal only
                inertia: true,
                onDrag: updatePositions,
                onThrowUpdate: updatePositions,
                onDragEnd: function () {
                    const threshold = 100;

                    // HORIZONTAL - NAVIGATE
                    if (this.x < -threshold) {
                        // SWIPE LEFT -> NEXT
                        gsap.to(lbImg, {
                            x: -window.innerWidth,
                            duration: 0.2,
                            ease: 'power2.in',
                            onComplete: () => {
                                nextImage();
                                resetProxy(this);
                            }
                        });
                    } else if (this.x > threshold) {
                        // SWIPE RIGHT -> PREV
                        gsap.to(lbImg, {
                            x: window.innerWidth,
                            duration: 0.2,
                            ease: 'power2.in',
                            onComplete: () => {
                                prevImage();
                                resetProxy(this);
                            }
                        });
                    } else {
                        // Snap Back Image
                        gsap.to(lbImg, { x: 0, duration: 0.3, ease: 'power2.out' });
                        gsap.to(this.target, { x: 0, duration: 0.3 }); // Reset proxy
                    }
                }
            })[0];

            function updatePositions() {
                gsap.set(lbImg, { x: this.x });
            }

            function resetProxy(instance) {
                gsap.set(instance.target, { x: 0, y: 0 });
                gsap.set(lbImg, { x: 0 }); // Fix: Explicitly reset image position
                instance.update();
            }
        }

        // Initialize on load
        window.addEventListener('load', initLightboxSwipe);

        // Hook into open/close to reset position
        const originalOpenLightbox = window.openLightbox;
        window.openLightbox = function (index) {
            // Reset position before opening
            gsap.set(lbImg, { x: 0 }); // Only reset image X
            originalOpenLightbox(index);
        };
    </script>
</Layout>
