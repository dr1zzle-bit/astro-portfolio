---
import Layout from '@layouts/Layout.astro';
import Navigation from '@components/Navigation.astro';
import { fetchProjects, fetchProjectBySlug } from '@data/project';
import { urlFor } from '../../utils/sanity-client';
import { PortableText } from '@portabletext/react';
import type { Project } from 'types';

export async function getStaticPaths() {
    const projects = await fetchProjects();
    return projects
        .filter((project: any) => project.slug?.current)
        .map((project: any) => ({
            params: { slug: project.slug.current }
        }));
}

const { slug } = Astro.params;
const project: Project = await fetchProjectBySlug(slug as string);

if (!project) return Astro.redirect('/404');
---

<Layout title={project.title} seoTitle={project.seoTitle} seoDescription={project.seoDescription} seoImage={project.seoImage}>
    <!-- Navigation Overlay -->
    <header class="fixed top-0 left-0 w-full z-40 p-8 flex justify-between items-start pointer-events-none">
        <a href="/" class="pointer-events-auto cursor-pointer group">
            <div
                class="apple-glass rounded-full px-5 py-2.5 flex items-center gap-3 transition-all duration-300 hover:scale-[1.02] text-black/60 group-hover:text-black"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="w-5 h-5 md:w-6 md:h-6 transition-transform duration-500 group-hover:-translate-x-1"
                >
                    <path d="m12 19-7-7 7-7"></path>
                    <path d="M19 12H5"></path>
                </svg>
                <h1 class="text-lg md:text-xl font-extrabold tracking-tighter transition-colors">Back</h1>
            </div>
        </a>
    </header>

    <!-- Combine Images for Lightbox -->
    <div class="pt-32 pb-20 px-4 md:px-8 max-w-7xl mx-auto min-h-screen">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-12 md:gap-24 mb-[10px] md:mb-24 items-start">
            <div class="space-y-6">
                <h1 class="text-5xl md:text-7xl font-extrabold tracking-tighter">{project.title}</h1>
                <p class="text-sm font-mono text-black/60 leading-relaxed">â†’ {project.description}</p>
                <div class="prose prose-lg mt-8 text-black/80 font-sans">
                    {project.details && <PortableText value={project.details} />}
                </div>
            </div>
            <div class="relative sticky top-32">
                {
                    project.mainImage?.asset && (
                        <img
                            src={urlFor(project.mainImage).width(1200).format('webp').url()}
                            alt={project.mainImage.alt || project.title}
                            class="w-full h-auto rounded-lg shadow-sm md:shadow-lg cursor-zoom-in hover:scale-[1.01] hover:opacity-90 transition-[transform,opacity] duration-500 ease-in-out will-change-transform"
                            onclick="openLightbox(0)"
                        />
                    )
                }
            </div>
        </div>

        {
            project.youtubeEmbed &&
                (() => {
                    const ytId = project.youtubeEmbed.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/)?.[2];
                    return ytId ? (
                        <div class="w-full aspect-video rounded-xl overflow-hidden shadow-lg mb-[10px] relative z-10">
                            <iframe
                                src={`https://www.youtube.com/embed/${ytId}?rel=0`}
                                title="Featured Video"
                                class="w-full h-full"
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                allowfullscreen
                            />
                        </div>
                    ) : null;
                })()
        }

        {
            project.gallery && project.gallery.length > 0 && (
                <div class="columns-1 custom-gallery gap-[10px] space-y-[10px]">
                    {project.gallery.map((item: any, index: number) => {
                        const realIndex = index + 1; // +1 because mainImage is 0

                        if (item._type === 'video' && item.videoUrl) {
                            return (
                                <div
                                    class="break-inside-avoid rounded-lg overflow-hidden shadow-sm group relative cursor-pointer"
                                    onclick={`openLightbox(${realIndex})`}
                                >
                                    <video src={item.videoUrl} muted loop autoplay playsinline class="w-full h-auto object-cover pointer-events-none" />
                                    <div class="absolute inset-0 flex items-center justify-center bg-black/10 group-hover:bg-black/20 transition-colors">
                                        <div class="bg-white/90 rounded-full p-2 backdrop-blur-sm">
                                            <i data-lucide="play" class="w-4 h-4 text-black fill-black" />
                                        </div>
                                    </div>
                                </div>
                            );
                        }

                        if (item._type === 'youtube' && item.url) {
                            const ytId = item.url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/)?.[2];
                            if (!ytId) return null;
                            const thumb = `https://img.youtube.com/vi/${ytId}/hqdefault.jpg`;

                            return (
                                <div
                                    class="break-inside-avoid rounded-lg overflow-hidden shadow-sm group relative cursor-pointer"
                                    onclick={`openLightbox(${realIndex})`}
                                >
                                    <img src={thumb} alt={item.caption || 'YouTube Video'} class="w-full h-auto object-cover" loading="lazy" />
                                    <div class="absolute inset-0 flex items-center justify-center bg-black/10 group-hover:bg-black/20 transition-colors">
                                        <div class="bg-white/90 rounded-full p-3 backdrop-blur-sm shadow-xl">
                                            <i data-lucide="youtube" class="w-6 h-6 text-red-600" />
                                        </div>
                                    </div>
                                </div>
                            );
                        }

                        // Default: Image
                        return (
                            item.asset && (
                                <div class="break-inside-avoid rounded-lg overflow-hidden shadow-sm group">
                                    <img
                                        src={urlFor(item).width(800).format('webp').url()}
                                        alt={item.alt || ''}
                                        data-index={realIndex}
                                        class="w-full h-auto object-cover hover:scale-[1.02] hover:opacity-90 transition-[transform,opacity] duration-500 ease-in-out cursor-zoom-in gallery-img will-change-transform"
                                        loading="lazy"
                                        onclick={`openLightbox(${realIndex})`}
                                    />
                                </div>
                            )
                        );
                    })}
                </div>
            )
        }
    </div>

    <style define:vars={{ desktopCols: project.galleryColumns || 3 }}>
        @media (min-width: 768px) {
            .custom-gallery {
                column-count: var(--desktopCols);
            }
        }
    </style>

    <!-- LIGHTBOX OVERLAY -->
    <div
        id="lightbox"
        class="fixed inset-0 z-[100] bg-white/95 backdrop-blur-xl flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300"
    >
        <button onclick="closeLightbox()" class="absolute top-8 right-8 p-2 hover:bg-black/5 rounded-full transition-colors z-20">
            <i data-lucide="x" class="w-8 h-8 text-black/60"></i>
        </button>

        <button onclick="prevImage()" class="absolute left-2 md:left-8 top-1/2 -translate-y-1/2 p-3 md:p-4 hover:bg-black/5 rounded-full transition-all z-50">
            <i data-lucide="chevron-left" class="w-6 h-6 md:w-8 md:h-8 text-black/80"></i>
        </button>

        <button onclick="nextImage()" class="absolute right-2 md:right-8 top-1/2 -translate-y-1/2 p-3 md:p-4 hover:bg-black/5 rounded-full transition-all z-50">
            <i data-lucide="chevron-right" class="w-6 h-6 md:w-8 md:h-8 text-black/80"></i>
        </button>

        <div class="relative w-full h-full flex items-center justify-center p-4 md:p-20">
            <div id="lightbox-content" class="w-full h-full flex items-center justify-center">
                <!-- Content injected via JS -->
            </div>
            <div id="lightbox-loader" class="absolute inset-0 flex items-center justify-center pointer-events-none hidden">
                <div class="w-8 h-8 border-2 border-black/20 border-t-black rounded-full animate-spin"></div>
            </div>
        </div>

        <div class="absolute bottom-8 left-1/2 -translate-x-1/2 text-black/50 text-sm font-medium tracking-widest">
            <span id="lb-current">1</span> / <span id="lb-total">1</span>
        </div>
    </div>

    <Navigation />

    <script
        is:inline
        define:vars={{
            allImages: [
                project.mainImage
                    ? {
                          type: 'image',
                          thumb: urlFor(project.mainImage).width(1200).format('webp').url(),
                          full: project.mainImage.useCrop
                              ? urlFor(project.mainImage).width(1800).format('webp').url()
                              : urlFor(project.mainImage.asset).width(1800).format('webp').url(),
                          alt: project.mainImage.alt || project.title
                      }
                    : null,
                ...(project.gallery || []).map((item) => {
                    if (item._type === 'video' && item.videoUrl) {
                        return { type: 'video', src: item.videoUrl, alt: item.alt };
                    }
                    if (item._type === 'youtube' && item.url) {
                        const ytId = item.url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/)?.[2];
                        return { type: 'youtube', id: ytId, caption: item.caption };
                    }
                    return {
                        type: 'image',
                        thumb: urlFor(item).width(800).format('webp').url(),
                        full: item.useCrop ? urlFor(item).width(1800).format('webp').url() : urlFor(item.asset).width(1800).format('webp').url(),
                        alt: item.alt || ''
                    };
                })
            ].filter(Boolean)
        }}
    >
        if (window.lucide) window.lucide.createIcons();

        // LIGHTBOX LOGIC
        const lightbox = document.getElementById('lightbox');
        const lbContent = document.getElementById('lightbox-content');
        const lbLoader = document.getElementById('lightbox-loader');
        const lbCurrent = document.getElementById('lb-current');
        const lbTotal = document.getElementById('lb-total');

        let currentIndex = 0;
        const totalImages = allImages.length;
        let lightboxDrag; // Declare globally for cleanup

        // Initialize Total
        if (lbTotal) lbTotal.innerText = totalImages;

        window.openLightbox = function (index) {
            if (!allImages.length) return;
            currentIndex = index;
            updateLightbox(true);

            lightbox.classList.remove('pointer-events-none', 'opacity-0');
            document.body.style.overflow = 'hidden'; // Lock Scroll
        };

        window.closeLightbox = function () {
            lightbox.classList.add('opacity-0', 'pointer-events-none');
            document.body.style.overflow = ''; // Unlock Scroll

            // Cleanup Content (Stop videos)
            setTimeout(() => {
                lbContent.innerHTML = '';
            }, 300);
        };

        window.nextImage = function (e) {
            if (e) e.stopPropagation();
            currentIndex = (currentIndex + 1) % totalImages;
            updateLightbox();
        };

        window.prevImage = function (e) {
            if (e) e.stopPropagation();
            currentIndex = (currentIndex - 1 + totalImages) % totalImages;
            updateLightbox();
        };

        function updateLightbox(firstOpen = false) {
            const data = allImages[currentIndex];
            if (!data) return;

            // Clear previous
            lbContent.innerHTML = '';
            lbLoader.classList.remove('hidden');

            const onLoaded = () => {
                lbLoader.classList.add('hidden');
                gsap.fromTo(lbContent.firstChild, { opacity: 0, scale: 0.95 }, { opacity: 1, scale: 1, duration: 0.3 });
            };

            if (data.type === 'image') {
                const img = document.createElement('img');
                img.src = data.full;
                img.alt = data.alt;
                img.className = 'max-w-full max-h-full object-contain shadow-2xl rounded-sm select-none';
                img.onload = onLoaded;
                lbContent.appendChild(img);
            } else if (data.type === 'video') {
                const video = document.createElement('video');
                video.src = data.src;
                video.controls = true;
                video.autoplay = true;
                video.className = 'max-w-full max-h-full object-contain shadow-2xl rounded-sm outline-none';
                video.onloadeddata = onLoaded;
                lbContent.appendChild(video);
            } else if (data.type === 'youtube' && data.id) {
                const iframe = document.createElement('iframe');
                iframe.src = `https://www.youtube.com/embed/${data.id}?autoplay=1&rel=0`;
                iframe.className = 'w-full max-w-4xl aspect-video rounded-lg shadow-2xl';
                iframe.allow = 'autoplay; encrypted-media';
                iframe.onload = onLoaded;
                lbContent.appendChild(iframe);
            }

            // Update Counter
            lbCurrent.innerText = currentIndex + 1;

            // Re-bind swipe since content changed (actually we bind swipe to container, but proxy might need reset)
            if (lightboxDrag && lightboxDrag[0]) {
                gsap.set(lightboxDrag[0].target, { x: 0, y: 0 });
            }
        }

        // Keyboard Nav
        document.addEventListener('keydown', (e) => {
            if (lightbox.classList.contains('opacity-0')) return;
            if (e.key === 'Escape') closeLightbox();
            if (e.key === 'ArrowRight') nextImage();
            if (e.key === 'ArrowLeft') prevImage();
        });

        // Background Click Close
        lightbox.addEventListener('click', (e) => {
            if (e.target === lightbox || e.target.parentElement === lightbox || e.target === lbContent) {
                closeLightbox();
            }
        });

        // --- SWIPE TO NAVIGATE (Horizontal Only) ---
        function initLightboxSwipe() {
            if (typeof Draggable === 'undefined') return;
            if (typeof InertiaPlugin !== 'undefined') gsap.registerPlugin(Draggable, InertiaPlugin);

            const proxy = document.createElement('div');

            lightboxDrag = Draggable.create(proxy, {
                trigger: lightbox,
                type: 'x',
                inertia: true,
                dragResistance: 0.3,
                onDragStart: function () {
                    // Disable for interactive elements like video controls
                    // Actually difficult to target specific children here, but trigger is lightbox wrapper
                },
                onDrag: updatePositions,
                onThrowUpdate: updatePositions,
                onDragEnd: function () {
                    const threshold = 100;
                    if (this.x < -threshold) {
                        gsap.to(lbContent, {
                            x: -50,
                            opacity: 0,
                            duration: 0.2,
                            onComplete: () => {
                                nextImage();
                                resetProxy(this);
                            }
                        });
                    } else if (this.x > threshold) {
                        gsap.to(lbContent, {
                            x: 50,
                            opacity: 0,
                            duration: 0.2,
                            onComplete: () => {
                                prevImage();
                                resetProxy(this);
                            }
                        });
                    } else {
                        // Snap Back
                        gsap.to(lbContent, { x: 0, opacity: 1, duration: 0.3 });
                        resetProxy(this);
                    }
                }
            });

            function updatePositions() {
                gsap.set(lbContent, { x: this.x });
            }

            function resetProxy(instance) {
                gsap.set(instance.target, { x: 0, y: 0 });
                gsap.set(lbContent, { x: 0, opacity: 1 });
                instance.update();
            }
        }

        window.addEventListener('load', initLightboxSwipe);
    </script>
</Layout>
